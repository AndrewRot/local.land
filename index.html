<!DOCTYPE html>
<html>
<head>
	<title>local.land</title>

	<!-- <link rel="icon" href="https://upload.wikimedia.org/wikipedia/commons/f/fc/Pigeon_silhouette_4874.svg"> -->
	<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
	<link href="https://fonts.googleapis.com/css?family=Abel" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Lobster" rel="stylesheet">
	<link rel="stylesheet" type="text/css" href="css/style.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>


	<script src="js/server.js" type="text/javascript"></script>
	<!-- JQuery needs to come before bootstrap js file  -->
<!-- 	<script src="https://code.jquery.com/jquery-3.1.1.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" ></script>
	<script src="https://use.fontawesome.com/8af70e38e3.js"></script> -->

</head>
<body>

	<nav class="navbar navbar-inverse navbar-fixed-top">
	  <div class="container-fluid">
	    <!-- Brand and toggle get grouped for better mobile display -->
	    <div class="navbar-header">
	      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
	        <span class="sr-only">Toggle navigation</span>
	        <span class="icon-bar"></span>
	        <span class="icon-bar"></span>
	        <span class="icon-bar"></span>
	      </button>
	      <a class="navbar-brand" href="#"><i class="fa fa-globe fa-1x" aria-hidden="true"></i> local.land</a>
	    </div>

	    <!-- Collect the nav links, forms, and other content for toggling -->
	    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
	      <ul class="nav navbar-nav">
	      	<li class="active"><a href="#"><i class="fa fa-home fa-1x" aria-hidden="true"></i> Home</a></li>
	      	<li><a href="html/about.html"><i class="fa fa-question-circle fa-1x" aria-hidden="true"></i> About</a></li>
	      </ul>
	      <ul class="nav navbar-nav navbar-right">
	        <li><a href="html/contact.html"><i class="fa fa-phone fa-1x" aria-hidden="true"></i> Contact</a></li>
	      </ul>
				<ul class="nav navbar-nav navbar-right">
					<li><a href="../html/ambassadors.html"><i class="fa fa-phone fa-1x" aria-hidden="true"></i> Ambassadors</a></li>
				</ul>
	    </div><!-- /.navbar-collapse -->
	  </div><!-- /.container-fluid -->
	</nav>

	<div class="container">
		<div class="row">
			<div class="col-lg-12">
				<div id="content">
					<h1>local.land</h1>
					<h3>CONNECTING PEOPLE WITH LOCAL FARMERS MARKETS</h3>
  					<div id="search">
    					<form action="submit" method="submit">
      				  <!--<input type="search" class= "searchinput" value="" placeholder=""/>-->
        				<input type="text" name="search" id = "ZippyZip" placeholder="Enter Location..." required title="Zip Code Must Be 5 Numbers">
    					</form>
						</div>
					<button type="submit" class="btn btn-primary">Search</button>
				</div>
			</div>
		</div>
	</div>

	<div id="gmap">
			<div id="map">
				<script>

				//Make sure that data inside this function is the data from the query, then use it to display markers. - assuming data doesnt have to be html content and can just be any variable
					$(function(){
					 $('#ZippyZip').on('keyup', function(e){
					   if(e.keyCode === 13) {
					     var parameters = { search: $(this).val() };
					       $.get( '/searching',parameters, function(data) {
					       	//#store results
					       $('#results').html(data);
					     });
					    };
					 });
					});

					//Input box enter search
					$('#ZippyZip').keypress(function (e) {
 					 if (e.which == 13) {
 					 		searchFor();
   						 codeAddress();
   						 scrollToLocation();

   						 return false;    //<---- Add this line
  						}
					});
					//search by clicking search button
					$('.btn').click(function() {
						searchFor();
						codeAddress();
						scrollToLocation();
  					});

					function scrollToLocation(){
						$('html, body').animate({
        					scrollTop: $("#map").offset().top //+ (.15 * $("#map").height())
    					}, 1000);
					}


					//From A5
					function searchFor() {
					  //Get value from search box
					  var searchMovieDiv = document.getElementById('ZippyZip')
					  var convertedLocation;


					  var resultsMap = map;
					  //Google geocoding
					  var geocoder = new google.maps.Geocoder();
					  var address = document.getElementById('ZippyZip').value;
				       geocoder.geocode({'address': address}, function(results, status) {
				          if (status === 'OK') {
				            resultsMap.setCenter(results[0].geometry.location);
				            //console.log(results[0].geometry.location);
				            convertedLocation = results[0].geometry.location; //update the searched location
				            var marker = new google.maps.Marker({
				              map: resultsMap,
				              position: results[0].geometry.location
				            });
				            reqListener();//wait till now to pass coordinates to server
				          } else {
				          	convertedLocation = "no location";
				          	console.log("****Fucked up");
				            alert('Geocode was not successful for the following reason: ' + status);
				          }
				      });

					  var oReq = new XMLHttpRequest();

				      //Handle result from geocoding
					  function reqListener () {
					  	oReq.open("POST", "/searchMovies", true);
					 	 // MAJOR KEY-- build form in XML http request SEND function
					  	console.log('search='+convertedLocation);

					  	//THIS ISSNT SENDING THE RESQUEST PROPERLY
					  	oReq.send('search='+convertedLocation);
					    oReq.addEventListener("load", receivedResponse); //Callback to next function
					  }

					  //Handle the server response
					  function receivedResponse(){
					  	//console.log(" req.responseText: "+oReq.response);
					  	popMap( JSON.parse(oReq.response) );
					  }

					}



					function popMap(foundMarkets){


						var iconBase = 'https://maps.google.com/mapfiles/kml/shapes/';
				        var icons = {
				          beer: {
				            //icon: iconBase + 'parking_lot_maps.png'
				            icon: 'images/beerimg.png'
				          },
				          farm: {
				            icon: 'images/logo.png'
				          }
				        };

				        function addMarker(foundMarkets) {
				        	//get position
				        	var position =  new google.maps.LatLng(foundMarkets.y, foundMarkets.x);

				          //switch to datapassed from DB
				          var marker = new google.maps.Marker({
				            	position: position,
				            	icon: icons['farm'].icon,
				            	map: map,
				            	title: foundMarkets.MarketName
				          	});
				          var contentString =
				          '<div id="MarkerContent">'+
					            '<div id="siteNotice">'+
					            '</div>'+
					            '<h4 id="firstHeading" class="firstHeading"><a href="'+foundMarkets.Website+'">'+ foundMarkets.MarketName+'</a></h4>'+
					            '<div id="bodyContent">'+
					            	'<p><b>State: </b>'+ foundMarkets.State+' <b>City:</b> '+ foundMarkets.city+' </p>'+
					            	'<p><b>Season: </b>'+ foundMarkets.Season1Date+' <b>Time:</b> '+ foundMarkets.Season1Time+' </p>'+
					           		'<div id="foodicons style= "display: "inline-flex"">'+
					           			getIcons(foundMarkets);
					           		'</div>'+
					       	 	'</div>'+
					       '</div>';

					        var infowindow = new google.maps.InfoWindow({
					          content: contentString
					        });

					        marker.addListener('click', function() {
					          infowindow.open(map, marker);
					        });
				        }

				        for (var i = 0; i < foundMarkets.length; i++) {
				          addMarker(foundMarkets[i]);
				        }
					}


					//retrieve food image icons
					//m - market we're getting data from
					function getIcons(m){
						var htmlcontent = '';
						//starts at index 30 - 29 different types of things
						//console.log(Object.keys(m));
						var attributes = ['Bakedgoods','Cheese','Crafts','Flowers','Eggs','Seafood','Herbs','Vegetables','Honey','Jams','Maple','Meat','Nursery','Nuts','Plants','Poultry','Prepared','Soap','Trees','Wine','Coffee','Beans','Fruits','Grains','Juices','Mushrooms','PetFood','Tofu','WildHarvested'];
						var values = Object.values(m);
						for(var i = 30; i < 59; i++){
							//if farm does have items, add to htmlcontent
							if(values[i] == 'Y'){
								var pictureName = attributes[i-30].toLowerCase();
								htmlcontent = htmlcontent + '<img src="../images/'+pictureName+'.png" title="'+pictureName+'" data-toggle="tooltip">';
							}
						}
						return htmlcontent;
					}



					//Attempting to read data from the text file

					var geocoder;
					var map; //This must be declared outside scope of function



					//function that initializes map
					function initMap() {
						geocoder = new google.maps.Geocoder();
						map = new google.maps.Map(document.getElementById('map'), {
							zoom: 13,
							center: new google.maps.LatLng(37.4419, -122.1419),
							scrollwheel: false,
							//custom colors
							styles: [	{		"featureType":"landscape",		"stylers":[			{				"hue":"#FFA800"			},			{				"saturation":0			},			{				"lightness":0			},			{				"gamma":1			}		]	},	{		"featureType":"road.highway",		"stylers":[			{				"hue":"#53FF00"			},			{				"saturation":-73			},			{				"lightness":40			},			{				"gamma":1			}		]	},	{		"featureType":"road.arterial",		"stylers":[			{				"hue":"#FBFF00"			},			{				"saturation":0			},			{				"lightness":0			},			{				"gamma":1			}		]	},	{		"featureType":"road.local",		"stylers":[			{				"hue":"#00FFFD"			},			{				"saturation":0			},			{				"lightness":30			},			{				"gamma":1			}		]	},	{		"featureType":"water",		"stylers":[			{				"hue":"#00BFFF"			},			{				"saturation":6			},			{				"lightness":8			},			{				"gamma":1			}		]	},	{		"featureType":"poi",		"stylers":[			{				"hue":"#679714"			},			{				"saturation":33.4			},			{				"lightness":-25.4			},			{				"gamma":1			}		]	}]
						});



						var infoWindow = new google.maps.InfoWindow({map: map});

				        // Geolocation services, start user at current geolocation
				        /*if (navigator.geolocation) {
				          	navigator.geolocation.getCurrentPosition(function(position) {
				            	var pos = {
				             	 	lat: position.coords.latitude,
				              		lng: position.coords.longitude
				            	};

				           		infoWindow.setPosition(pos);
				            	infoWindow.setContent('Your Location');
				            	map.setCenter(pos);
				          	}, function() {
				            	handleLocationError(true, infoWindow, map.getCenter());
				          	});
				        } else {
				          // Browser doesn't support Geolocation
				          handleLocationError(false, infoWindow, map.getCenter());
				        }*/

				        //Custom icons test

				        //

				        //populateMap(); //right now just use a test group

					}

					//function handleLocationError(browserHasGeolocation, infoWindow, pos) {
				  //      infoWindow.setPosition(pos);
				  //      infoWindow.setContent(browserHasGeolocation ?
				  //                            'Error: The Geolocation service failed.' :
				  //                            'Error: Your browser doesn\'t support geolocation.');
				  //    }




					//google.maps.event.addDomListener(window, "load", initialize);
					// We add a DOM event here to show an alert if the DIV containing the

        			// map is clicked. INSERT MAP interaction here
        			//google.maps.event.addDomListener(map, 'click', function() {
          				//window.alert('Map was clicked!');
        			//});

					//google.maps.event.addDomListener(window, "", initialize);

					//Handle relocating map when user searchers
					function codeAddress() {
						console.log(document.getElementById('ZippyZip').value);
					    var address = document.getElementById('ZippyZip').value;
					    geocoder.geocode( { 'address': address}, function(results, status) {
					      if (status == 'OK') {
					        map.setCenter(results[0].geometry.location);
					        var marker = new google.maps.Marker({
					            map: map,
					            position: results[0].geometry.location
					        });

					      } else {
					        alert('Geocode was not successful for the following reason: ' + status);
					      }
					    });
					}


				</script>
			</div>
			<div id="vis" style='background-image: url("https://source.unsplash.com/tI_Odb7ZU6M"); background-size: cover;'>
				<div id="datavis" >
					<h3>DATA VIS GOES HERE!</h3>
					<div id = "svgPanel">
					<svg width="960" height="500" ></svg>
					</div>
					<script src="https://d3js.org/d3.v4.min.js"></script>
					<script>
					//https://source.unsplash.com/tI_Odb7ZU6M
					//https://unsplash.com/search/wood?photo=x7JLwunX0M0
						var svg1 = d3.select("svg"),
						margin = {top: 20, right: 20, bottom: 30, left: 40},
						width = +svg1.attr("width") - margin.left - margin.right,
						height = +svg1.attr("height") - margin.top - margin.bottom;
						var x = d3.scaleBand().rangeRound([0, width]).padding(0.1),
								y = d3.scaleLinear().rangeRound([height, 0]);
						var g = svg1.append("g")
								.attr("transform", "translate(" + margin.left + "," + margin.top + ")");
						d3.tsv("states.tsv", function(d) {
							d.number = +d.number;
							return d;
						}, function(error, data) {
							if (error) throw error;
							x.domain(data.map(function(d) { return d.name; }));
							y.domain([0, d3.max(data, function(d) { return d.number; })]);
							g.append("g")
									.attr("class", "axis axis--x")
									.attr("transform", "translate(0," + height + ")")
									//.attr('xlink:href', 'images/blueberries.jpg')
									.call(d3.axisBottom(x));
							g.append("g")
									.attr("class", "axis axis--y")
									//.attr('xlink:href', 'images/blueberries.jpg')
									.call(d3.axisLeft(y).ticks(50))
								.append("text")
									.attr("transform", "rotate(-90)")
									.attr("y", 6)
									.attr("dy", "0.71em")
									.attr("text-anchor", "end")
									.text("Number of Markets");
							g.selectAll(".bar")
								.data(data)
								.enter().append("rect")
									.attr("class", "bar")
									.attr("x", function(d) { return x(d.name); })
									.attr("y", function(d) { return y(d.number); })
									.attr("width", x.bandwidth())
									.attr("height", function(d) { return height - y(d.number); });
							g.append("g")
								    .attr("xlink:href", "http://cdn.wallpapersafari.com/95/40/IebAXK.jpg");
								    //.attr("d", "M 0,0, 57.7,-100, 115.5,0z")
								    //.attr("transform", "translate(135.5, 100)")
								    //.attr("fill", "http://cdn.wallpapersafari.com/95/40/IebAXK.jpg");
						});
					</script>
				</div>
			</div>
	</div>

  <nav class="navbar navbar-inverse navbar-fixed-bottom" id="footer">
	  <div class="container-fluid">
	    <div class="navbar-header">
	      <p class="navbar-text">
          	Copyright 2016 ©
						<a href="https://github.com/dmmcmaster" target="_blank" title="Derek's Github">Derek McMaster</a>,
						<a href="https://github.com/Ksbugbee" target="_blank" title="Kurt's Github">Kurt Bugbee</a>,
						<a href="https://github.com/AndrewRot" target="_blank" title="Andrew's Github"> Andrew Rottier</a>
          </p>
	    </div>
	  </div>
	</nav>

<!-- SCRIPTS AIzaSyCDOrBPsEiCUDcIruZU79x5qxbb4VhhlAM-->

<!-- SCRIPTS -->
	<script src="js/stacked.js"></script>
	<script src="https://maps.googleapis.com/maps/api/js"></script>
	<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCPEdZKfT-QclO5EjLMKGPFS9zuY1mnA-c&callback=initMap"></script>
	<script src="https://code.jquery.com/jquery-3.1.1.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" ></script>
	<script src="https://use.fontawesome.com/8af70e38e3.js"></script>
</body>
</html>
